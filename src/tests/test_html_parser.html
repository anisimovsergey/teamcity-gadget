<html>
<head>
    <title>HTML parser tests</title>

    <script type="text/javascript" language="javascript" src="../../../jsunit2_2/jsunit/app/jsUnitCore.js"></script>

    <script type="text/javascript" language="javascript" src="../scripts/environment.js"></script>
    
    <script type="text/javascript" language="javascript" src="../scripts/object_model.js"></script>

    <script type="text/javascript" language="javascript" src="../scripts/html_parser.js"></script>

    <script type="text/javascript" language="javascript">

        var _parser;
        var _xmlDoc;

        function setUp() {
            _parser = new HtmlParser();
            _xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
        }

        ///////////////////////////////////////////////////////////////////////////////
        // GetConfigurationStatus Tests
        ///////////////////////////////////////////////////////////////////////////////        

        function test_Get_Configuration_Status_Success() {
            var status = GetConfigurationStatus("<img src=\"success.gif\"/>");
            assertEquals(ConfigurationStatus.Success, status);
        }

        function test_Get_Configuration_Status_Unknown() {
            var status = GetConfigurationStatus("<img src=\"buildGray.gif\"/>");
            assertEquals(ConfigurationStatus.Unknown, status);
        }

        function test_Get_Configuration_Status_Error() {
            var status = GetConfigurationStatus("<img src=\"error.gif\"/>");
            assertEquals(ConfigurationStatus.Error, status);
        }

        function test_Get_Configuration_Status_Fixing() {
            var status = GetConfigurationStatus("<img src=\"errorWithResp.gif\"/>");
            assertEquals(ConfigurationStatus.Fixing, status);
        }

        function test_Get_Configuration_Status_Fixing() {
            var status = GetConfigurationStatus("<img src=\"errorWithResp.gif\"/>");
            assertEquals(ConfigurationStatus.Fixing, status);
        }

        function test_Get_Configuration_Status_Fixed() {
            var status = GetConfigurationStatus("<img src=\"fixed.gif\"/>");
            assertEquals(ConfigurationStatus.Fixed, status);
        }

        function test_Get_Configuration_Status_Ignored() {
            var status = GetConfigurationStatus("<img src=\"ignored.gif\"/>");
            assertEquals(ConfigurationStatus.Ignored, status);
        }

        // TeamCity version 6.5
        function test_Get_Configuration_Status_Archived_As_Paused() {
            var status = GetConfigurationStatus("<img src=\"archived.gif\"/>");
            assertEquals(ConfigurationStatus.Paused, status);
        }

        function test_Get_Configuration_Status_Paused() {
            var status = GetConfigurationStatus("<img src=\"paused.gif\"/>");
            assertEquals(ConfigurationStatus.Paused, status);
        }

        function test_Get_Configuration_Status_Pending() {
            var status = GetConfigurationStatus("<img src=\"pending.gif\"/>");
            assertEquals(ConfigurationStatus.Pending, status);
        }

        function test_Get_Configuration_Status_Unknown_RandomSrc() {
            var status = GetConfigurationStatus("<img src=\"random123.gif\"/>");
            assertEquals(ConfigurationStatus.Unknown, status);
        }

        function test_Get_Configuration_Status_Unknown_NoSrc() {
            var status = GetConfigurationStatus("<img />");
            assertEquals(ConfigurationStatus.Unknown, status);
        }

        ///////////////////////////////////////////////////////////////////////////////
        // GetBuildStatus Tests
        ///////////////////////////////////////////////////////////////////////////////

        function test_BuildStatus_ForSuccessSmall_IsSuccessNotPersonal() {
            CheckBuildStatus("prefix/success_small.gif", BuildStatus.Success, false);
        }

        // TeamCity version 6.5
        function test_BuildStatus_ForBuildSuccess_IsSuccessNotPersonal() {
            CheckBuildStatus("prefix/buildSuccess.gif", BuildStatus.Success, false);
        }

        function test_BuildStatus_ForPersonalSuccess_IsSuccessPersonal() {
            CheckBuildStatus("prefix/personalSuccess.gif", BuildStatus.Success, true);
        }

        function test_BuildStatus_ForErrorSmall_IsErrorNotPersonal() {
            CheckBuildStatus("prefix/error_small.gif", BuildStatus.Error, false);
        }

        // TeamCity version 6.5
        function test_BuildStatus_ForBuildFailed_IsErrorNotPersonal() {
            CheckBuildStatus("prefix/buildFailed.gif", BuildStatus.Error, false);
        }

        function test_BuildStatus_ForPersonalCrashed_IsErrorPersonal() {
            CheckBuildStatus("prefix/personalCrashed.gif", BuildStatus.Error, true);
        }

        function test_BuildStatus_ForCanceled_IsCanceledNotPersonal() {
            CheckBuildStatus("prefix/canceled.gif", BuildStatus.Canceled, false);
        }

        function test_BuildStatus_ForPersonalCanceled_IsCanceledPersonal() {
            CheckBuildStatus("prefix/personalCanceled.gif", BuildStatus.Canceled, true);
        }

        function test_BuildStatus_ForPending_IsPendingNotPersonal() {
            CheckBuildStatus("prefix/pending.gif", BuildStatus.Pending, false);
        }

        function test_BuildStatus_ForPersonalPending_IsPendingPersonal() {
            CheckBuildStatus("prefix/personalPending.gif", BuildStatus.Pending, true);
        }

        function test_BuildStatus_ForRunningGreenTransparent_IsRunningGreenNotPersonal() {
            CheckBuildStatus("prefix/running_green_transparent.gif", BuildStatus.RunningGreen, false);
        }

        function test_BuildStatus_ForPersonalRunningGreen_IsRunningGreenPersonal() {
            CheckBuildStatus("prefix/personalRunning_green.gif", BuildStatus.RunningGreen, true);
        }

        function test_BuildStatus_ForRunningRedTransparent_IsRunningRedNotPersonal() {
            CheckBuildStatus("prefix/running_red_transparent.gif", BuildStatus.RunningRed, false);
        }

        function test_BuildStatus_ForPersonalRunningRed_IsRunningRedPersonal() {
            CheckBuildStatus("prefix/personalRunning_red.gif", BuildStatus.RunningRed, true);
        }

        // TeamCity version 6.5
        function test_BuildStatus_ForRedSign_IsErrorNotPersonal() {
            CheckBuildStatus("prefix/redSign.png", BuildStatus.Error, false);
        }

        // TeamCity version 6.5
        function test_BuildStatus_ForRedSignPersonal_IsErrorPersonal() {
            CheckBuildStatus("prefix/redSignPersonal.png", BuildStatus.Error, true);
        }

        function test_BuildStatus_ForRandomImage_IsUnknownNotPersonal() {
            CheckBuildStatus("random123.gif", BuildStatus.Unknown, false);
        }

        function test_BuildStatus_ForNoImage_IsUnknownNotPersonal() {
            CheckBuildStatus("", BuildStatus.Unknown, false);
        }

        ///////////////////////////////////////////////////////////////////////////////
        // Escape / Unescape functions
        ///////////////////////////////////////////////////////////////////////////////

        function test_Escape_Text() {
            assertEquals("*%26*", _parser._Escape("*&*"));
        }

        function test_UnEscape_Text() {
            assertEquals("*&*", _parser._UnEscape("*%26*"));
        }

        ///////////////////////////////////////////////////////////////////////////////
        // Parse projects and configurations 
        ///////////////////////////////////////////////////////////////////////////////

        function test_Parse_Builds() {

            _parser._ParseBuild = function(buildRow) { return new Build() };

            _xmlDoc.loadXML(BuildsData.innerHTML);
            var builds = _parser._ParseBuilds(_xmlDoc.selectSingleNode(".//div[@id = \"Configuration\"]"));

            assertNotNull(builds);
            assertEquals(2, builds.length);
        }

        function test_Parse_Project() {

            _xmlDoc.loadXML("<project>Manhattan</project>");
            var project = _parser._ParseProject(_xmlDoc.documentElement);

            assertNotNull(project);
            assertEquals("Manhattan", project.GetName());
        }

        function test_Parse_List_Of_Projects_And_Configurations() {

            _parser._ParseProject = function() { return new Project(); };
            _parser._ParseConfiguration = function() { return new Configuration() };

            _xmlDoc.loadXML(ProjectsAndConfigurationsData.innerHTML);
            var projects = _parser._ParseXml(_xmlDoc);

            assertEquals(2, projects.length);
            assertEquals(2, projects[0].Configurations.length);
            assertEquals(2, projects[1].Configurations.length);
        }

        function test_ParseConfiguration_Configuration() {

            _parser._UnEscape = function(text) { return "_UnEscape" + text; };
            _parser._UnEscapeMessage = function(text) { return "_UnEscapeMessage" + text; };
            _parser._GetConfigurationStatus = function() { return "_GetConfigurationStatus"; };

            _parser._ParseBuilds = function() {
                var builds = [];
                builds.push(new Build());
                return builds;
            };

            _xmlDoc.loadXML(ParseConfigurationXml.innerHTML);
            var config = _parser._ParseConfiguration(_xmlDoc.documentElement, null);

            assertNotNull(config);
            assertEquals("_UnEscapeRelease", config.GetName());
            assertEquals("_UnEscapea href", config.GetLink());
            assertEquals("_GetConfigurationStatus", config.GetStatus());
            assertEquals(1, config.Builds.length);
        }

        ///////////////////////////////////////////////////////////////////////////////
        // Extraction status of configurations and builds
        ///////////////////////////////////////////////////////////////////////////////

        function test_GetStatusElement_Embeded_ReturnsStatusElement() {
            
            _xmlDoc.loadXML(ToolTipTextXml.innerHTML);

            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"Embeded\"]");
            var element = _parser._GetStatusElement(currentNode);

            assertNotNull(element);
        }

        function test_GetStatusElement_Linked_ReturnsStatusElement() {
            
            _xmlDoc.loadXML(ToolTipTextXml.innerHTML);

            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"Linked\"]");
            var element = _parser._GetStatusElement(currentNode);

            assertNotNull(element);
        }

        function test_GetStatusElement_LinkedAndEmbeded_TheSameInternally() {
            
            _xmlDoc.loadXML(ToolTipTextXml.innerHTML);

            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"Embeded\"]");
            var elementEmbd = _parser._GetStatusElement(currentNode);

            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"Linked\"]");
            var elementLink = _parser._GetStatusElement(currentNode);

            assertEquals(elementEmbd.childNodes.length, elementLink.childNodes.length);
            
            for (i = 0; i < elementEmbd.childNodes.length; i++)
                assertEquals(elementEmbd.childNodes[i].xml, elementLink.childNodes[i].xml);
        }

        function test_ExtractStatusToolTip_OnComplexText_RemovesExtraTags() {
            
            _xmlDoc.loadXML(ToolTipTextXml.innerHTML);

            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"Embeded\"]");
            var element = _parser._GetStatusElement(currentNode);
            var message = _parser._ExtractStatusToolTip(element);

            assertEquals("ToolTipText. BuildAgent Server", message);
        }

        function test_ExtractStatusToolTip_OnComplexTextWidthPersonal_ExtractsAllData() {

            _xmlDoc.loadXML(ToolTipTextXml.innerHTML);

            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"EmbededPersonal\"]");
            var element = _parser._GetStatusElement(currentNode);
            var message = _parser._ExtractStatusToolTip(element);

            assertEquals("ToolTipText. Personal. BuildAgent Server", message);
        }

        function test_ExtractStatusMessage_OnComplexText_RetainsExtraTags_V6_5() {
            
            _xmlDoc.loadXML(ToolTipTextXml.innerHTML);
            debugger;
            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"EmbededV65\"]");
            var element = _parser._GetStatusElement(currentNode);
            var message = _parser._ExtractStatusMessage(element);

            assertEquals("Paused by <strong>Sergey Anisimov</strong>&nbsp;<span class=\"date\" title=\"10 hours ago\">10 hours ago</span><br/>Comment: TestMessage ", message);
        }

        function test_ExtractStatusMessage_OnComplexText_RetainsExtraTags() {

            _xmlDoc.loadXML(ToolTipTextXml.innerHTML);

            var currentNode = _xmlDoc.selectSingleNode(".//div[@id = \"Linked\"]");
            var element = _parser._GetStatusElement(currentNode);
            var message = _parser._ExtractStatusMessage(element);

            assertEquals("ToolTipText<br/>BuildAgent<a href=\"link\" title=\"title\">Server</a>", message);
        }

        function test_GetStatusElement_WithoutMouseover_ReturnsNull() {

            _xmlDoc.loadXML("<test/>");
            var element = _parser._GetStatusElement(_xmlDoc.documentElement);

            assertNull(element);
        }
        
        ///////////////////////////////////////////////////////////////////////////////
        // Extracting additional configuration data for flyout
        ///////////////////////////////////////////////////////////////////////////////

        function test_ExtractConfigurationData_NodeWithConfigurationStatusTooltip_ExtractsStatusToolTip() {
            
            var config = ParseConfiguration(ParseConfigurationXml);
            var configData = _parser._ExtractConfigurationData(config.GetDataElement());

            assertEquals("ConfigurationStatusTooltip", configData.GetStatusMessage());
        }      

        ///////////////////////////////////////////////////////////////////////////////
        // Extracting additional build data for flyout
        ///////////////////////////////////////////////////////////////////////////////

        function test_ExtractBuildData_NodeWithBuildNumber_ExtractsBuildNumber() {
    
            var build = ParseBuild(ExtractBuildDataXml);
            var buildData = _parser._ExtractBuildData(build.GetDataElement());

            assertEquals("# 777", buildData.GetBuildNumber());
        }

        function test_ExtractBuildData_NodeWithBuidStatusTooltip_ExtractsStatusToolTip() {

            var build = ParseBuild(ExtractBuildDataXml);
            var buildData = _parser._ExtractBuildData(build.GetDataElement());

            assertEquals("BuidStatusTooltip", buildData.GetStatusToolTip());
        }

        function test_ExtractBuildData_NodeWithBuidResults_ExtractsBuildResults() {

            var build = ParseBuild(ExtractBuildDataXml);
            var buildData = _parser._ExtractBuildData(build.GetDataElement());

            assertEquals("BuidResults", buildData.GetBuildResults());
        }

        function test_ExtractBuildData_NodeWithBuidResultsLink_ExtractsBuildResultsLink() {

            var build = ParseBuild(ExtractBuildDataXml);
            var buildData = _parser._ExtractBuildData(build.GetDataElement());

            assertEquals("BuidResultsLink", buildData.GetBuildResultsLink());
        }

        function test_ExtractBuildData_NodeWithBuidChanges_ExtractsBuildChanges() {

            var build = ParseBuild(ExtractBuildDataXml);
            var buildData = _parser._ExtractBuildData(build.GetDataElement());

            assertEquals("BuildChanges", buildData.GetBuildChanges());
        }

        function test_ExtractBuildData_NodeWithBuidChangesLink_ExtractsBuildChangesLink() {

            var build = ParseBuild(ExtractBuildDataXml);
            var buildData = _parser._ExtractBuildData(build.GetDataElement());

            assertEquals("BuildChangesLink", buildData.GetBuildChangesLink());
        }

        ///////////////////////////////////////////////////////////////////////////////
        // Extracting additional configuration and build data for flyout
        ///////////////////////////////////////////////////////////////////////////////

        function test_ParseDataElement_ForConfigWithDataElement_ExtractsConfigurationData() {

            var configuration = new Configuration(null, null, null, null, "DataElement");
            var configDataElement;

            _parser._ExtractConfigurationData = function(dataElement) {
                configDataElement = dataElement;
                return "Data";
            };
            
            _parser.ParseDataElement(configuration);
            assertEquals("DataElement", configDataElement);
            assertEquals("Data", configuration.GetData());
        }

        function test_ParseDataElement_ForAllBuilds_ExtractsBuildData() {

            var configuration = new Configuration();
            var configDataElement = "";
            
            configuration.Builds.push(new Build(null, null, "DataElement"));
            configuration.Builds.push(new Build(null, null, "DataElement"));

            _parser._ExtractConfigurationData = function(dataElement) {
                return null;
            };

            _parser._ExtractBuildData = function(dataElement) {
                configDataElement = configDataElement + dataElement;
                return "Data";
            };

            _parser.ParseDataElement(configuration);
            assertEquals("DataElementDataElement", configDataElement);
            assertEquals("Data", configuration.Builds[0].GetData());
            assertEquals("Data", configuration.Builds[1].GetData());
        }
        
        ///////////////////////////////////////////////////////////////////////////////
        // Success and Error parsing (Basic)
        ///////////////////////////////////////////////////////////////////////////////

        function test_Initail_State_Of_Pareser() {
            assertNotNull(_parser.GetProjects());
            assertEquals(0, _parser.GetErrorCode());
        }

        function test_Correct_Xml_Parsing() {
            _parser.ProcessHtml("<Doc/>");
            assertEquals(0, _parser.GetErrorCode());
        }

        function test_Incorrect_Xml_Parsing() {
            _parser.ProcessHtml("<Doc>");
            assertNotEquals(0, _parser.GetErrorCode());
        }

        function test_Reset_Xml_Status() {

            _parser.ProcessHtml("<Doc>");
            assertNotEquals(0, _parser.GetErrorCode());

            _parser.ProcessHtml("<Doc/>");
            assertEquals(0, _parser.GetErrorCode());
        }

        ///////////////////////////////////////////////////////////////////////////////
        // Helper functions
        ///////////////////////////////////////////////////////////////////////////////

        function CheckBuildStatus(imageName, statusRequired, isPersonalRequired) {

            var imageTag = "<img src=\"" + imageName + "\"/>";
            
            var status = GetBuildStatus(imageTag);
            var isPersonal = IsBuildPersonal(imageTag);

            assertEquals(statusRequired, status);
            assertEquals(isPersonalRequired, isPersonal);
        }

        function GetConfigurationStatus(nodeText) {

            _xmlDoc.loadXML(nodeText);
            var image_node = _xmlDoc.documentElement;

            return _parser._GetConfigurationStatus(image_node);
        }

        function GetBuildStatus(nodeText) {

            _xmlDoc.loadXML(nodeText);
            var image_node = _xmlDoc.documentElement;

            return _parser._GetBuildStatus(image_node);
        }

        function IsBuildPersonal(nodeText) {

            _xmlDoc.loadXML(nodeText);
            var image_node = _xmlDoc.documentElement;

            return _parser._IsBuildPersonal(image_node);
        }

        function ParseConfiguration(configurationXmlData) {

            _xmlDoc.loadXML(configurationXmlData.innerHTML);
            return _parser._ParseConfiguration(_xmlDoc.documentElement);
        }

        function ParseBuild(buildXmlData) {

            _xmlDoc.loadXML(buildXmlData.innerHTML);
            return _parser._ParseBuild(_xmlDoc.documentElement);
        }

    </script>
</head>
<body>
    <span id="ruler" style="visibility:hidden; white-space:nowrap"></span>
    <xml id="ProjectsAndConfigurationsData">
        <div class="panel">
            <div class="projectHeader">
                Manhattan</div>
            <div class="buildConfigurationName">
            </div>
            <div class="buildConfigurationName">
            </div>
            <div class="projectHeader">
                Brooklyn</div>
            <div class="buildConfigurationName">
            </div>
            <div class="buildConfigurationName">
            </div>
        </div>
    </xml>
    <xml id="ParseConfigurationXml">
        <div class="buildConfigurationName">
            <span>
                <img onmouseover='--- "ConfigurationStatusTooltip" ---'/>
            </span> 
            <a class="buildTypeName" style="" href="a href">Release</a>
        </div>
    </xml>
    <xml id="ToolTipTextXml" >
        <div>
            <div id="Embeded" onmouseover='--- "ToolTipText%26lt;br/%26gt;BuildAgent%26lt;a href=\%26#034;link\%26#034; title=\%26#034;title\%26#034;%26gt;Server%26lt;/a%26gt;" ---'></div>                
            <div id="EmbededPersonal" onmouseover='--- "ToolTipText%26lt;br/%26gt;Personal%26lt;br/%26gt;BuildAgent%26lt;a href=\%26#034;link\%26#034; title=\%26#034;title\%26#034;%26gt;Server%26lt;/a%26gt;" ---'></div>                            
            <div id="Linked" onmouseover='--- "dataHover_2" ---'></div>
            <div id="dataHover_2">ToolTipText<br/>BuildAgent<a href="link" title="title">Server</a></div>
            <div id="EmbededV65" onmouseover='BS.Tooltip.showMessage(this, {shift:{x:10, y:5}, hideDelay: 10}, "Paused by %26lt;strong%26gt;Sergey Anisimov%26lt;\/strong%26gt;%26amp;nbsp;%26lt;span class=\%26#034;date\%26#034; title=\%26#034;10 hours ago\%26#034;%26gt;10 hours ago%26lt;\/span%26gt;%26lt;br\/%26gt;Comment: TestMessage%26lt;br%26gt;");'></div>
        </div>
    </xml>
    <xml id="BuildsData">
        <div>
            <div id="Configuration"/>
            <table>
                <tr />
                <tr />
            </table>
        </div>
    </xml>
    <xml id="ExtractBuildDataXml">
        <tr>
            <td class="buildNumber">
                # 777
            </td>
            <td>
                <img onmouseover='--- "BuidStatusTooltip" ---'/>
                <a href="BuidResultsLink"><span id="build:000000:text">BuidResults</span></a>
            </td>
            <td class="changesColumn">
                <a href="BuildChangesLink">BuildChanges</a>
            </td>
        </tr>
    </xml>
</body>
</html>
